let WindowURL=window.location.search,newWindowURL=WindowURL.replace("?tid=cid.c."," "),reslinksplit=(newWindowURL=newWindowURL.replace("?tid=cid.g."," ")).split("&"),FacebookIdString=reslinksplit[0].split("%3A"),port=chrome.runtime.connect({name:"knockknock"});port.postMessage({UserAndFriendId:FacebookIdString,ConFlag:"INDVAL"}),port.onMessage.addListener(async function(e){if("INDVALBACK"==e.ConFlagBack){let s="",o="",n="",i=e.userInfoDetails.FaceBookUsername,a=e.userInfoDetails.AutoResponderKeyword,t=e.userInfoDetails.DefaultMessageState,r=e.userInfoDetails.IsFaceBookLoggedIn,l=e.userInfoDetails.AutoresponderStatus,g=e.userInfoDetails.FacebooKFriendId.trim(),c=e.userInfoDetails.FacebookUserId.trim(),d=e.userInfoDetails.MfenevanId.trim(),I=$.now();if($("#messageGroup").find("div").find(".e").length>0){let e=$("#messageGroup").find("div").find(".e").length;$("#messageGroup").find("div").find(".e").each(async function(i){if(i+1===e){$(this).last().html();s=$(this).last().find("div").children("a").attr("href");let e=$(this).last().find("div").children("a").children("strong").html();o=e.trim(),$(this).last().find("div").children("div").each(async function(){$(this).children("span").html()&&(n=n+" "+$(this).children("span").html())})}});let m=o.split(" "),p=0,F="",f="";if(m.length>1?m.map(function(e){0===p?F=e:f=f+" "+e,p+=1}):F=m,o==i.trim())port.postMessage({ConFlag:"UDATEIFRAMEURLONLY"});else{IncomingMessage=n.split(",").join(" , "),IncomingMessage=IncomingMessage.split(".").join("  "),IncomingMessage=IncomingMessage.split("?").join(" "),IncomingMessage=IncomingMessage.split("<br>").join(" "),IncomingMessage=IncomingMessage.split("`").join(" "),IncomingMessage=IncomingMessage.split("'").join(" "),IncomingMessage=IncomingMessage.split('"').join(" "),IncomingMessage=IncomingMessage.split("*").join(" "),IncomingMessage=IncomingMessage.split("’").join(" "),IncomingMessage=IncomingMessage.split("“").join(" "),IncomingMessage=IncomingMessage.split("”").join(" "),IncomingMessage=" "+IncomingMessage+" ",IncomingMessage=IncomingMessage.toLowerCase();let e=JSON.parse(a);if(0==e.length)if("1"==t){let e={ResponseTime:I,FriendProfileLink:s,FriendFirstName:F,FriendLastName:f,FacebooKFriendId:g,FacebookUserId:c};port.postMessage({ConFlag:"CHECKELIGABLEFORDEFAULTMESSAGE",payload:e})}else port.postMessage({ConFlag:"UDATEIFRAMEURLONLY"});else{let o="";if(await e.map(function(e){let s=e.keyword.toLowerCase();s=" "+s+" ",-1!=IncomingMessage.indexOf(s)&&(o=""==o?e.message:o+" "+e.message)}),""==o)if("1"==t&&"true"==r){let e={ResponseTime:I,FriendProfileLink:s,FriendFirstName:F,FriendLastName:f,FacebooKFriendId:g,FacebookUserId:c};port.postMessage({ConFlag:"CHECKELIGABLEFORDEFAULTMESSAGE",payload:e})}else port.postMessage({ConFlag:"UDATEIFRAMEURLONLY"}),console.log("TODO Call postMessage to Background to update the link in Iframe222222222222222222 :TYPEONE");else if("true"==r&&"1"==l){$("#composerInput").val(o),$("#composer_form").submit();let e={FacebookFirstName:F,FacebookLastName:f,FacebookUserId:c,FriendFacebookId:g,MfenevanId:d,ProfileLink:s,ResponseMessage:o,ResponseTime:I,MessageSenderType:"last_contact_outgoing"};port.postMessage({ConFlag:"STORESENDDETAILS",payload:e})}else if("true"==r&&"0"==l&&"1"==t){let e={ResponseTime:I,FriendProfileLink:s,FriendFirstName:F,FriendLastName:f,FacebooKFriendId:g,FacebookUserId:c};port.postMessage({ConFlag:"CHECKELIGABLEFORDEFAULTMESSAGE",payload:e})}else port.postMessage({ConFlag:"UDATEIFRAMEURLONLY"})}}}else port.postMessage({ConFlag:"UDATEIFRAMEURLONLY"})}if("INDVALBACKDEFAULT"==e.ConFlagBack){$("#composerInput").val(e.userInfoDetails.ResponseMessage),$("#composer_form").submit();let s=$.now(),o={FacebookFirstName:e.userInfoDetails.FacebookFirstName,FacebookLastName:e.userInfoDetails.FacebookLastName,FacebookUserId:e.userInfoDetails.FacebookUserId,FriendFacebookId:e.userInfoDetails.FriendFacebookId,MfenevanId:e.userInfoDetails.MfenevanId,ProfileLink:e.userInfoDetails.ProfileLink,ResponseMessage:e.userInfoDetails.ResponseMessage,ResponseTime:s,MessageSenderType:"last_default_message_time"};port.postMessage({ConFlag:"STORESENDDETAILS",payload:o})}}),chrome.runtime.onMessage.addListener(async function(e,s,o){e.catch});