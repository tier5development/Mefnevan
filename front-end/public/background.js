const getApiUrl="https://api.mefnevan.com/",MessageListUrl="https://mbasic.facebook.com/messages",mBasicUrl="https://mbasic.facebook.com",mFacebook="https://m.facebook.com",method={POST:"post",GET:"get",PUT:"put",DELETE:"delete"},toJsonStr=e=>JSON.stringify(e),handleRequest=(e,t,a)=>{return fetch(getApiUrl+e,{method:t,headers:{Accept:"application/json","Content-Type":"application/json","Access-Control-Allow-Origin":!0},body:a})};function CheckLocalStoreAndHitIndividualMList(){let e=localStorage.getItem("ListURLArray"),t=localStorage.getItem("CheckMessageNReply"),a=localStorage.getItem("fb_logged_id"),o=localStorage.getItem("inBackgroundFetching"),s=localStorage.getItem("default_message"),l=localStorage.getItem("autoresponder");if("true"==a&&"false"==o&&(0!=s||0!=l)&&0==t){let t=JSON.parse(e);if(0===t.length)localStorage.setItem("CheckMessageNReply",0);else{let e=parseInt(localStorage.getItem("fbprofile")),a=t[0];chrome.tabs.update(e,{url:a},function(e){let t=e.id;localStorage.setItem("fbthread",t)});let o=JSON.parse(localStorage.getItem("ListURLArray")),s=t.indexOf(a);if(-1!==s){o.splice(s,1);let e=JSON.stringify(o);localStorage.setItem("ListURLArray",e)}else{let e=JSON.stringify(o);localStorage.setItem("ListURLArray",e)}localStorage.setItem("CheckMessageNReply",1)}}}chrome.runtime.onMessage.addListener(async function(e,t){if("storeUserInfoOrQueryThenStore"==e.type){let t={user_rec:localStorage.getItem("kyubi_user_token"),fb_id:e.options.FacebookId,fb_username:e.options.FacebookUsername,fb_name:e.options.FacebookName,fb_image:e.options.FacebookImage,fb_logged_id:e.options.LoggedInFacebook};!0===e.options.LoggedInFacebook&&(localStorage.setItem("fb_id",e.options.FacebookId),localStorage.setItem("fb_username",e.options.FacebookUsername),localStorage.setItem("fb_name",e.options.FacebookName),localStorage.setItem("fb_image",e.options.FacebookImage),localStorage.setItem("fb_logged_id",e.options.LoggedInFacebook)),await handleRequest("api/user/userCheckStoreNRetrive",method.POST,toJsonStr(t)).then(async t=>{let a=await t.json();localStorage.setItem("CheckMessageNReply",0),localStorage.setItem("ListURLArray","[]"),localStorage.setItem("kyubi_user_token",a.payload.UserInfo.kyubi_user_token),localStorage.setItem("user_id",a.payload.UserInfo.user_id),localStorage.setItem("fb_id",a.payload.UserInfo.facebook_fbid),localStorage.setItem("fb_username",a.payload.UserInfo.facebook_name),localStorage.setItem("fb_name",a.payload.UserInfo.facebook_profile_name),localStorage.setItem("fb_image",a.payload.UserInfo.facebook_image),localStorage.setItem("fb_logged_id",e.options.LoggedInFacebook),localStorage.setItem("inBackgroundFetching",!1);let o=0,s=0,l=e.options.LoggedInFacebook;if(a.payload.UserSettings.default_message?(localStorage.setItem("default_message",a.payload.UserSettings.default_message),s=a.payload.UserSettings.default_message):localStorage.setItem("default_message",0),a.payload.UserSettings.default_message_text?localStorage.setItem("default_message_text",a.payload.UserSettings.default_message_text):localStorage.setItem("default_message_text",""),a.payload.UserSettings.autoresponder?(localStorage.setItem("autoresponder",a.payload.UserSettings.autoresponder),o=a.payload.UserSettings.autoresponder):localStorage.setItem("autoresponder",0),a.payload.UserSettings.default_time_delay&&localStorage.setItem("default_time_delay",a.payload.UserSettings.default_time_delay),localStorage.setItem("keywordsTally",JSON.stringify(a.payload.AutoResponderKeywords)),(1==o||1==s)&&1==l)if(localStorage.getItem("fbmunread")){let e=parseInt(localStorage.getItem("fbmunread"));chrome.tabs.get(e,function(e){if(!e){const e="https://m.facebook.com/messages/";chrome.tabs.create({url:e,active:!1,pinned:!0},function(e){let t=e.id;localStorage.setItem("fbmunread",t)})}})}else{const e="https://m.facebook.com/messages/";chrome.tabs.create({url:e,active:!1,pinned:!0},function(e){let t=e.id;localStorage.setItem("fbmunread",t)})}}).catch(e=>{})}else if("StoreMessageLinkInLocalStorage"==e.type){let t=localStorage.getItem("ListURLArray"),a=JSON.parse(t);if(0===a.length){a[a.length]=mBasicUrl+""+e.options;let t=JSON.stringify(a);localStorage.setItem("ListURLArray",t)}else{if(a.includes(mBasicUrl+""+e.options));else{a[a.length]=mBasicUrl+""+e.options;let t=JSON.stringify(a);localStorage.setItem("ListURLArray",t)}}CheckLocalStoreAndHitIndividualMList()}}),chrome.runtime.onConnect.addListener(function(e){e.onMessage.addListener(async function(t){if("CheckMessageContent"==t.ConFlag){let a=localStorage.getItem("fb_username"),o=localStorage.getItem("fb_id");a=a.trim();let s=t.MessageDetails.profile_name.trim(),l=t.MessageDetails.ProfileLink.trim();if(t.MessageDetails.facebook_Id[0].trim()==o.trim()?FacebooKFriendId=t.MessageDetails.facebook_Id[1].trim():FacebooKFriendId=t.MessageDetails.facebook_Id[0].trim(),a!=s){let a=localStorage.getItem("fb_logged_id"),i=localStorage.getItem("inBackgroundFetching"),r=localStorage.getItem("default_message"),n=localStorage.getItem("autoresponder");if("true"==a&&"false"==i)if(0!=r||0!=n){let a=t.MessageDetails.message_content.split(",").join(" , ");a=" "+(a=(a=(a=(a=(a=(a=(a=(a=(a=(a=(a=(a=(a=(a=(a=(a=(a=a.split(".").join("  ")).split("?").join(" ")).split("<br>").join(" ")).split("`").join(" ")).split("'").join(" ")).split('"').join(" ")).split("*").join(" ")).split("’").join(" ")).split("“").join(" ")).split("”").join(" ")).split("!").join(" ")).split("@").join(" ")).split("#").join(" ")).split("%").join(" ")).split("&").join(" ")).split("*").join(" ")).split("^").join(" ")).toLowerCase()+" ";let i=s,r=localStorage.getItem("keywordsTally"),n=localStorage.getItem("user_id"),c=JSON.parse(r),g=i.split(" "),d=0,m="",f="",p=(new Date).getTime();if(g.length>1?g.map(function(e){0===d?m=e:f=f+" "+e,d+=1}):m=g,0==c.length){let e={MfenevanId:n,FacebookUserId:o,FriendFacebookId:FacebooKFriendId,FacebookFirstName:m,FacebookLastName:f,ProfileLink:l,TimeNow:p},t=await handleRequest("api/friend/checkFriendReadyToReciveDefaultMessage",method.POST,toJsonStr(e));await t.json();localStorage.setItem("CheckMessageNReply",0),CheckLocalStoreAndHitIndividualMList()}else{let t=[],s="";if(await c.map(function(e){let o=e.keyword.toLowerCase();if(o=" "+o+" ",-1!=a.indexOf(o)){let s=a.indexOf(o);t[s]=e.message}}),0===t.length){let t={MfenevanId:n,FacebookUserId:o,FriendFacebookId:FacebooKFriendId,FacebookFirstName:m,FacebookLastName:f,ProfileLink:l,TimeNow:p},a=await handleRequest("api/friend/checkFriendReadyToReciveDefaultMessage",method.POST,toJsonStr(t)),s=await a.json();1==s.code?e.postMessage({userInfoDetails:s.payload.message,ThreadParams:t,ConFlagBack:"DEFAULTMESSAGEBACK"}):(localStorage.setItem("CheckMessageNReply",0),CheckLocalStoreAndHitIndividualMList())}else{t.filter((e,t,a)=>a.indexOf(e)===t).map(e=>{s=s+" "+e});let a=new Date(p),i=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],r=a.getFullYear(),c=i[a.getMonth()],g=a.getDate(),d=(a.getHours(),a.getMinutes(),a.getSeconds(),g+" "+c+" "+r),I=s.split("{first_name}").join(m);I=(I=(I=I.split("{last_name}").join(f)).split("{Date}").join(d)).split("{date}").join(d);let S={MfenevanId:n,FacebookUserId:o,FriendFacebookId:FacebooKFriendId,FacebookFirstName:m,FacebookLastName:f,ProfileLink:l,TimeNow:p,ResponseMessage:I};e.postMessage({userInfoDetails:I,ThreadParams:S,ConFlagBack:"AUTOMESSAGEBACK"})}}}else localStorage.setItem("CheckMessageNReply",0),CheckLocalStoreAndHitIndividualMList();else localStorage.setItem("CheckMessageNReply",0),CheckLocalStoreAndHitIndividualMList()}else localStorage.setItem("CheckMessageNReply",0),CheckLocalStoreAndHitIndividualMList()}if("STOREANDCLOSE"==t.ConFlag){let e={FacebookFirstName:t.MessageDetails.FacebookFirstName,FacebookLastName:t.MessageDetails.FacebookLastName,FacebookUserId:t.MessageDetails.FacebookUserId,FriendFacebookId:t.MessageDetails.FriendFacebookId,MessageSenderType:t.MessageDetails.MessageSenderType,MfenevanId:t.MessageDetails.MfenevanId,ProfileLink:t.MessageDetails.ProfileLink,ResponseMessage:t.MessageDetails.ResponseMessage,ResponseTime:t.MessageDetails.ResponseTime};await handleRequest("api/friend/saveLastMessageOutForFriend",method.POST,toJsonStr(e)).then(e=>{localStorage.setItem("CheckMessageNReply",0),CheckLocalStoreAndHitIndividualMList()})}if("StoreMessageLinkInLocalStorage"==t.ConFlag){let e=localStorage.getItem("ListURLArray"),a=JSON.parse(e);if(0===a.length){a[a.length]=mBasicUrl+""+t.options;let e=JSON.stringify(a);localStorage.setItem("ListURLArray",e)}else{if(a.includes(mBasicUrl+""+t.options));else{a[a.length]=mBasicUrl+""+t.options;let e=JSON.stringify(a);localStorage.setItem("ListURLArray",e)}}CheckLocalStoreAndHitIndividualMList()}})}),setInterval(async function(){if(localStorage.getItem("fbmunread")){let e=parseInt(localStorage.getItem("fbmunread"));chrome.tabs.remove(e,function(){localStorage.removeItem("fbmunread")})}if(localStorage.getItem("fbthread")){let e=parseInt(localStorage.getItem("fbthread"));chrome.tabs.remove(e,function(){localStorage.removeItem("fbthread")})}await chrome.tabs.query({},async function(e){await e.forEach(function(e){"https://mbasic.facebook.com/"==e.url&&chrome.tabs.remove(e.id,function(){});e.url.indexOf("https://m.facebook.com/messages/read/?")>-1&&chrome.tabs.remove(e.id,function(){})})});await chrome.tabs.create({url:"https://mbasic.facebook.com",active:!1,pinned:!0},function(e){let t=parseInt(e.id);localStorage.setItem("fbprofile",t)}),localStorage.setItem("CheckMessageNReply",0)},9e5);