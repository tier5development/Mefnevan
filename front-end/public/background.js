const getApiUrl="http://3.236.238.87:8008/",MessageListUrl="https://mbasic.facebook.com/messages",mBasicUrl="https://mbasic.facebook.com",mFacebook="https://m.facebook.com",method={POST:"post",GET:"get",PUT:"put",DELETE:"delete"},toJsonStr=e=>JSON.stringify(e),handleRequest=(e,t,a)=>{return fetch(getApiUrl+e,{method:t,headers:{Accept:"application/json","Content-Type":"application/json","Access-Control-Allow-Origin":!0},body:a})};async function TallyWithKeyWordsOrDefault(e,t,a,o,s,l){let i=localStorage.getItem("keywordsTally"),r=localStorage.getItem("user_id"),n=JSON.parse(i),c=t.split(" "),g=0,d="",m="",f=(new Date).getTime();if(c.length>1?c.map(function(e){0===g?d=e:m=m+" "+e,g+=1}):d=c,0==n.length){let e={MfenevanId:r,FacebookUserId:s,FriendFacebookId:a,FacebookFirstName:d,FacebookLastName:m,ProfileLink:l,TimeNow:f},t=await handleRequest("api/friend/checkFriendReadyToReciveDefaultMessage",method.POST,toJsonStr(e));await t.json()}else{let t=[],o="";if(await n.map(function(a){let o=a.keyword.toLowerCase();if(o=" "+o+" ",-1!=e.indexOf(o)){let s=e.indexOf(o);t[s]=a.message}}),0!==t.length){t.map(e=>{o=o+" "+e});let e=new Date(f),a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],s=e.getFullYear(),l=a[e.getMonth()],i=e.getDate(),r=(e.getHours(),e.getMinutes(),e.getSeconds(),i+" "+l+" "+s),n=o.split("{first_name}").join(d);return{userInfoDetails:n=(n=(n=n.split("{last_name}").join(m)).split("{Date}").join(r)).split("{date}").join(r),ConFlagBack:"AUTOMESSAGEBACK"}}{let e={MfenevanId:r,FacebookUserId:s,FriendFacebookId:a,FacebookFirstName:d,FacebookLastName:m,ProfileLink:l,TimeNow:f},t=await handleRequest("api/friend/checkFriendReadyToReciveDefaultMessage",method.POST,toJsonStr(e)),o=await t.json();if(1==o.code)return{userInfoDetails:o,ConFlagBack:"DEFAULTMESSAGEBACK"}}}}function CheckLocalStoreAndHitIndividualMList(){let e=localStorage.getItem("ListURLArray"),t=localStorage.getItem("CheckMessageNReply"),a=localStorage.getItem("fb_logged_id"),o=localStorage.getItem("inBackgroundFetching"),s=localStorage.getItem("default_message"),l=localStorage.getItem("autoresponder");if("true"==a&&"false"==o&&(0!=s||0!=l)&&0==t){let t=JSON.parse(e);t.length>0&&(document.getElementById("messageIndividualMain").src="",document.getElementById("messageIndividualMain").src=t[0],localStorage.setItem("CheckMessageNReply",1))}}chrome.runtime.onMessage.addListener(async function(e,t){if("storeUserInfoOrQueryThenStore"==e.type){let t={user_rec:localStorage.getItem("kyubi_user_token"),fb_id:e.options.FacebookId,fb_username:e.options.FacebookUsername,fb_name:e.options.FacebookName,fb_image:e.options.FacebookImage,fb_logged_id:e.options.LoggedInFacebook};await handleRequest("api/user/userCheckStoreNRetrive",method.POST,toJsonStr(t)).then(async t=>{let a=await t.json();localStorage.setItem("CheckMessageNReply",0),localStorage.setItem("ListURLArray","[]"),localStorage.setItem("kyubi_user_token",a.payload.UserInfo.kyubi_user_token),localStorage.setItem("user_id",a.payload.UserInfo.user_id),localStorage.setItem("fb_id",a.payload.UserInfo.facebook_fbid),localStorage.setItem("fb_username",a.payload.UserInfo.facebook_name),localStorage.setItem("fb_name",a.payload.UserInfo.facebook_profile_name),localStorage.setItem("fb_image",a.payload.UserInfo.facebook_image),localStorage.setItem("fb_logged_id",e.options.LoggedInFacebook),localStorage.setItem("inBackgroundFetching",!1),localStorage.setItem("profileFetch",0),localStorage.setItem("messageListFetch",0),localStorage.setItem("individualMessageFetch",0),UserLoggedInFacebook=e.options.LoggedInFacebook,BackGroundFetchingStatus=!1,a.payload.UserSettings.default_message?(localStorage.setItem("default_message",a.payload.UserSettings.default_message),DefaultMessageStatus=a.payload.UserSettings.default_message):localStorage.setItem("default_message",0),a.payload.UserSettings.default_message_text?localStorage.setItem("default_message_text",a.payload.UserSettings.default_message_text):localStorage.setItem("default_message_text",""),a.payload.UserSettings.autoresponder?(localStorage.setItem("autoresponder",a.payload.UserSettings.autoresponder),AutoResponderStatus=a.payload.UserSettings.autoresponder):localStorage.setItem("autoresponder",0),a.payload.UserSettings.default_time_delay&&localStorage.setItem("default_time_delay",a.payload.UserSettings.default_time_delay),localStorage.setItem("keywordsTally",JSON.stringify(a.payload.AutoResponderKeywords)),1!=AutoResponderStatus&&1!=DefaultMessageStatus||1!=UserLoggedInFacebook||0!=BackGroundFetchingStatus||(document.getElementById("profileFrame").src="",document.getElementById("messageListMain").src="https://m.facebook.com/messages/")}).catch(e=>{localStorage.setItem("profileFetch",0),localStorage.setItem("messageListFetch",0),localStorage.setItem("individualMessageFetch",0)})}if("OpenMessageProfileToRead"==e.type){localStorage.setItem("profileFetch",1),document.getElementById("profileFrame").src=e.options;let t=[],a=JSON.stringify(t);localStorage.setItem("ListURLArray",a),localStorage.setItem("CheckMessageNReply",0)}if("CloseAllForResponse"==e.type){localStorage.setItem("profileFetch",0);let e=[],t=JSON.stringify(e);localStorage.setItem("ListURLArray",t),localStorage.setItem("CheckMessageNReply",0),document.getElementById("profileFrame").src="",document.getElementById("messageListMain").src="",document.getElementById("messageIndividualMain").src=""}if(e.type,"StoreMessageLinkInLocalStorage"==e.type){let t=localStorage.getItem("ListURLArray"),a=JSON.parse(t);if(0===a.length){a[a.length]=mBasicUrl+""+e.options;let t=JSON.stringify(a);localStorage.setItem("ListURLArray",t)}else{if(a.includes(mBasicUrl+""+e.options));else{a[a.length]=mBasicUrl+""+e.options;let t=JSON.stringify(a);localStorage.setItem("ListURLArray",t)}}CheckLocalStoreAndHitIndividualMList()}}),chrome.webRequest.onHeadersReceived.addListener(function(e){var t=e.responseHeaders,a=t.findIndex(e=>"x-frame-options"==e.name.toLowerCase());return-1!=a&&t.splice(a,1),{responseHeaders:t}},{urls:["*://*.facebook.com/*","*://m.facebook.com/*"],types:["sub_frame"]},["blocking","responseHeaders"]),chrome.runtime.onConnect.addListener(function(e){e.onMessage.addListener(async function(t){if("INDVAL"==t.ConFlag){let e=localStorage.getItem("ListURLArray"),a=JSON.parse(e);if(0===a.length){a[a.length]=mBasicUrl+""+t.SendURL;let e=JSON.stringify(a);localStorage.setItem("ListURLArray",e)}else{if(a.includes(mBasicUrl+""+t.SendURL));else{a[a.length]=mBasicUrl+""+t.SendURL;let e=JSON.stringify(a);localStorage.setItem("ListURLArray",e)}}CheckLocalStoreAndHitIndividualMList()}if("CheckMessageContent"==t.ConFlag){let a=localStorage.getItem("fb_username"),o=localStorage.getItem("fb_id");a=a.trim();let s=t.MessageDetails.profile_name.trim(),l=t.MessageDetails.ProfileLink.trim();if(t.MessageDetails.facebook_Id[0].trim()==o.trim()?FacebooKFriendId=t.MessageDetails.facebook_Id[1].trim():FacebooKFriendId=t.MessageDetails.facebook_Id[0].trim(),a!=s){let a=localStorage.getItem("fb_logged_id"),i=localStorage.getItem("inBackgroundFetching"),r=localStorage.getItem("default_message"),n=localStorage.getItem("autoresponder");if("true"==a&&"false"==i)if(0!=r||0!=n){let a=t.MessageDetails.message_content.split(",").join(" , ");a=(a=" "+(a=(a=(a=(a=(a=(a=(a=(a=(a=(a=a.split(".").join("  ")).split("?").join(" ")).split("<br>").join(" ")).split("`").join(" ")).split("'").join(" ")).split('"').join(" ")).split("*").join(" ")).split("’").join(" ")).split("“").join(" ")).split("”").join(" "))+" ").toLowerCase();let i=s,r=localStorage.getItem("keywordsTally"),n=localStorage.getItem("user_id"),c=JSON.parse(r),g=i.split(" "),d=0,m="",f="",S=(new Date).getTime();if(g.length>1?g.map(function(e){0===d?m=e:f=f+" "+e,d+=1}):m=g,0==c.length){let e={MfenevanId:n,FacebookUserId:o,FriendFacebookId:FacebooKFriendId,FacebookFirstName:m,FacebookLastName:f,ProfileLink:l,TimeNow:S},t=await handleRequest("api/friend/checkFriendReadyToReciveDefaultMessage",method.POST,toJsonStr(e));await t.json()}else{let s=[],i="";if(await c.map(function(e){let t=e.keyword.toLowerCase();if(t=" "+t+" ",-1!=a.indexOf(t)){let o=a.indexOf(t);s[o]=e.message}}),0===s.length){let a={MfenevanId:n,FacebookUserId:o,FriendFacebookId:FacebooKFriendId,FacebookFirstName:m,FacebookLastName:f,ProfileLink:l,TimeNow:S},s=await handleRequest("api/friend/checkFriendReadyToReciveDefaultMessage",method.POST,toJsonStr(a)),i=await s.json();if(1==i.code)e.postMessage({userInfoDetails:i.payload.message,ThreadParams:a,ConFlagBack:"DEFAULTMESSAGEBACK"});else{let e=JSON.parse(localStorage.getItem("ListURLArray")),a=e.indexOf(t.MessageDetails.location_details);if(-1!==a){e.splice(a,1);let t=JSON.stringify(e);localStorage.setItem("ListURLArray",t),document.getElementById("messageIndividualMain").src="",localStorage.setItem("CheckMessageNReply",0),CheckLocalStoreAndHitIndividualMList()}}}else{s.map(e=>{i=i+" "+e});let t=new Date(S),a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],r=t.getFullYear(),c=a[t.getMonth()],g=t.getDate(),d=(t.getHours(),t.getMinutes(),t.getSeconds(),g+" "+c+" "+r),I=i.split("{first_name}").join(m);I=(I=(I=I.split("{last_name}").join(f)).split("{Date}").join(d)).split("{date}").join(d);let p={MfenevanId:n,FacebookUserId:o,FriendFacebookId:FacebooKFriendId,FacebookFirstName:m,FacebookLastName:f,ProfileLink:l,TimeNow:S};e.postMessage({userInfoDetails:I,ThreadParams:p,ConFlagBack:"AUTOMESSAGEBACK"})}}}else{let e=JSON.parse(localStorage.getItem("ListURLArray")),a=e.indexOf(t.MessageDetails.location_details);if(-1!==a){e.splice(a,1);let t=JSON.stringify(e);localStorage.setItem("ListURLArray",t),document.getElementById("messageIndividualMain").src="",localStorage.setItem("CheckMessageNReply",0),CheckLocalStoreAndHitIndividualMList()}}else{let e=JSON.parse(localStorage.getItem("ListURLArray")),a=e.indexOf(t.MessageDetails.location_details);if(-1!==a){e.splice(a,1);let t=JSON.stringify(e);localStorage.setItem("ListURLArray",t),document.getElementById("messageIndividualMain").src="",localStorage.setItem("CheckMessageNReply",0),CheckLocalStoreAndHitIndividualMList()}}}else{let e=JSON.parse(localStorage.getItem("ListURLArray")),a=e.indexOf(t.MessageDetails.location_details);if(-1!==a){e.splice(a,1);let t=JSON.stringify(e);localStorage.setItem("ListURLArray",t),document.getElementById("messageIndividualMain").src="",localStorage.setItem("CheckMessageNReply",0),CheckLocalStoreAndHitIndividualMList()}}}if("STOREANDCLOSE"==t.ConFlag){let e={FacebookFirstName:t.MessageDetails.FacebookFirstName,FacebookLastName:t.MessageDetails.FacebookLastName,FacebookUserId:t.MessageDetails.FacebookUserId,FriendFacebookId:t.MessageDetails.FriendFacebookId,MessageSenderType:t.MessageDetails.MessageSenderType,MfenevanId:t.MessageDetails.MfenevanId,ProfileLink:t.MessageDetails.ProfileLink,ResponseMessage:t.MessageDetails.ResponseMessage,ResponseTime:t.MessageDetails.ResponseTime},a=(await handleRequest("api/friend/saveLastMessageOutForFriend",method.POST,toJsonStr(e)),JSON.parse(localStorage.getItem("ListURLArray"))),o=a.indexOf(t.MessageDetails.LocationDetails);if(-1!==o){a.splice(o,1);let e=JSON.stringify(a);localStorage.setItem("ListURLArray",e),document.getElementById("messageIndividualMain").src="",localStorage.setItem("CheckMessageNReply",0),CheckLocalStoreAndHitIndividualMList()}}})});